<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>DevSpeak - Ingl√™s para Devs (Cen√°rios)</title>
    <style>
        /* ====== CSS: Estilos da Aplica√ß√£o (Integrado) ====== */
        
        /* Base / Theme Duolingo-style */
        :root{
            /* Cores Duolingo */
            --duo-green-dark: #58cc02; /* Para Bal√£o B e Elementos Prim√°rios */
            --duo-green-light: #80e900;
            --duo-blue-dark: #1cb0f6; /* Para Bal√£o A e Elementos Secund√°rios */
            --duo-blue-light: #58d8ff;
            --primary: var(--duo-blue-dark);
            
            --gray-bg: #f3f4f6;
            --gray-border: #d1d5db;
            --font-base: clamp(16px, 2.5vw, 18px);
            --radius: 1rem;
            --shadow: 0 4px 12px rgba(0,0,0,.1);
            
            /* Safe Areas (Para Mobile) */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; }

        html, body{
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
            font-size: var(--font-base);
            background: var(--gray-bg);
            min-height: 100vh;
        }

        body{
            display:flex;
            align-items:flex-start;
            justify-content:center;
            padding-top: calc(50px + var(--safe-top));
            padding-bottom: var(--safe-bottom);
        }

        .card{
            background:#fff; width:100%; max-width: 800px;
            padding: clamp(16px, 3.5vw, 32px);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display:flex; flex-direction:column;
        }

        h2{ font-size: clamp(1.125rem, 3.5vw, 1.5rem); margin: 0 0 1rem 0; }
        h3{ font-size: clamp(1rem, 3.5vw, 1.25rem); margin: 0 0 1rem 0; }


        /* Nav Header (Topo) */
        .nav-header{
            background: var(--duo-blue-dark); color: #fff;
            position: fixed; top: 0; left: 0; right: 0;
            padding: 10px clamp(12px, 3.5vw, 32px);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,.15);
            z-index: 100;
            height: calc(50px + var(--safe-top));
            padding-top: var(--safe-top);
        }
        .nav-header h1{ font-size: 1.25rem; margin: 0; font-weight: 700; }
        .nav-header-icons{ display: flex; align-items: center; gap: 1rem; }

        /* Buttons & Inputs */
        .btn{
            width:100%;
            padding: clamp(12px, 3.2vw, 14px) clamp(16px, 3.5vw, 20px);
            margin-top:.75rem; border:0; border-radius: .75rem;
            font-weight:600; cursor:pointer; text-align:center; font-size: 1rem;
            transition: filter .15s ease, transform .02s ease;
            touch-action: manipulation;
        }
        .btn:active{ transform: scale(.99); }
        .btn.primary{ background: var(--primary); color:#fff; }
        .btn.secondary{ background:#e5e7eb; color:#111827; }
        .btn.ghost{ background:transparent; color:var(--primary); }
        .btn.danger{ background:#ef4444; color:#fff; } /* Estilo para o bot√£o de reset */


        .flex{ display:flex; }
        .gap-md{ gap: 1rem; }

        .hint-btn{
            background: transparent; border: none; cursor: pointer;
            font-size: 1.5rem; padding: 0 .5rem; line-height: 1; height: 44px;
        }
        
        .audio-btn{ /* Estilo para o bot√£o de √°udio no flashcard */
            background: transparent; border: 2px solid; border-radius: 50%;
            cursor: pointer; font-size: 1rem; padding: 5px;
            width: 35px; height: 35px; display: flex; justify-content: center; align-items: center;
            transition: background 0.1s;
        }
        /* Button on the new Front (English/Green) should be dark */
        .card-front .audio-btn { border-color: #1f2937; color: #1f2937;} 
        /* Button on the new Back (Portuguese/Blue) should be white */
        .card-back .audio-btn { border-color: #fff; color: #fff;} 
        .audio-btn:hover { background: rgba(0,0,0,0.1); }


        .input-group{
            position: relative; display:flex; align-items:center; width:100%;
            gap:.5rem; margin-bottom: .75rem; flex-wrap: wrap; 
        }

        .hint-bubble{
            position: absolute; right: 0; bottom: calc(100% + 8px);
            background:#111827; color:#fff; padding:.5rem .75rem; border-radius:.5rem;
            font-size:.95rem; white-space:pre-wrap; display:none; max-width: min(92vw, 420px); z-index:10;
        }
        .hint-bubble::after{
            content:''; position:absolute; bottom:-8px; right:12px; border-width:8px 8px 0 8px;
            border-style:solid; border-color:#111827 transparent transparent transparent;
        }

        .toolbar{
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: .75rem; margin-top:.25rem;
        }
        .toolbar .btn{ margin-top:0; }

        /* Estilos de Mapa/Navega√ß√£o Duolingo */
        #map-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding-top: 10px;
            padding-bottom: 80px;
        }

        .day-path {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0 10px;
            position: relative;
        }

        .day-node {
            position: relative;
            z-index: 2;
            padding-bottom: 20px; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .day-node p {
            margin: .5rem 0 0; 
            text-align: center; 
        }
        
        .day-path > div:not(.day-node){
            height: 40px; 
            width: 4px; 
            background: var(--gray-border); 
            margin: 0 auto;
        }


        /* Bolha Principal (Dia no Mapa) */
        .main-bubble {
            width: 80px; height: 80px;
            background: var(--duo-green-dark);
            border: 4px solid var(--duo-green-light);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; color: #fff; font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,.2);
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .main-bubble:hover { transform: scale(1.05); }

        /* Bolhas de Cen√°rio e Sub-Li√ß√£o */
        .scenario-bubble, .sub-bubble {
            width: 60px; height: 60px;
            border: 4px solid var(--duo-blue-light);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,.15);
            cursor: pointer;
            transition: transform 0.1s ease;
            font-size: 1.4rem;
            font-weight: 500;
        }
        .scenario-bubble {
            width: 70px; height: 70px;
            font-size: 1.6rem;
            background: var(--duo-blue-dark);
            border-color: var(--duo-blue-light);
        }
        
        .sub-bubble.role-A { background: var(--duo-blue-dark); border-color: var(--duo-blue-light); }
        .sub-bubble.role-B { background: var(--duo-green-dark); border-color: var(--duo-green-light); }
        .sub-bubble.completed, .scenario-bubble.completed {
            background: var(--gray-border);
            border-color: #9ca3af;
            color: #4b5563;
        }
        .sub-bubble.active, .scenario-bubble.active {
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(43, 114, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(43, 114, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(43, 114, 255, 0); }
        }

        /* Estilo para a Tela de Flash Card */
        .flashcard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        .flashcard {
            width: 100%; max-width: 400px; height: 250px;
            background: #fff; border: 2px solid var(--duo-blue-dark);
            border-radius: 15px;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; font-weight: 600; color: #1f2937;
            box-shadow: 0 8px 16px rgba(0,0,0,.15);
            cursor: pointer;
            perspective: 1000px; 
            margin-bottom: 20px;
        }
        .card-inner {
            position: relative;
            width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped .card-inner { transform: rotateY(180deg); }
        .card-front, .card-back {
            position: absolute;
            width: 100%; height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding: 20px;
            border-radius: 13px;
        }
        /* SWAPPED COLORS for English (Front) and Portuguese (Back) */
        .card-front { background: var(--duo-green-light); color: #1f2937; } 
        .card-back { background: var(--duo-blue-light); color: #fff; transform: rotateY(180deg); } 
        
        .flashcard-progress { margin-bottom: 15px; font-size: 1rem; color: #4b5563; }
        .flashcard-nav { display: flex; gap: 10px; margin-top: 20px; }


        /* Chat Simulator */
        .chat-scroll{
            flex:1; max-height: min(60vh, 520px); 
            overflow-y:auto; margin-bottom: 1rem; padding-right: 4px;
            -webkit-overflow-scrolling: touch;
        }
        .chat-bubble{
            max-width: 85%; padding: 1rem; border-radius: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,.08);
            font-size: 1rem; line-height: 1.45; margin: .25rem 0;
            word-wrap: break-word; overflow-wrap: anywhere; color: #fff;
        }
        .bubble-a{ background: var(--duo-blue-dark); }
        .bubble-b{ background: var(--duo-green-dark); }
        .hidden-text{ filter: blur(8px); cursor: pointer; transition: filter 160ms ease; user-select: none; }
        .hidden-text.revealed{ filter: none; user-select: text; }
        audio{ width:100%; margin-top:.5rem; }

        /* Estilo de Erro de Input */
        .input-group input {
            padding: 10px; 
            border: 2px solid var(--gray-border); 
            border-radius: 8px; 
            flex-grow: 1;
            transition: border-color 0.2s;
        }
        .input-group input.error-input {
            border-color: #ef4444; /* Vermelho */
        }
        
        /* NOVO: Menu de Configura√ß√µes */
        .settings-menu{
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 200;
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: calc(70px + var(--safe-top));
            visibility: hidden; opacity: 0; transition: opacity 0.3s, visibility 0.3s;
        }
        .settings-menu.visible{
            visibility: visible; opacity: 1;
        }
        .settings-menu-content{
            background: white; border-radius: var(--radius); padding: 20px;
            width: 90%; max-width: 350px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .settings-menu-content h3{ margin-top: 0; color: #111827;}


        @media (min-width: 640px){
            .chat-bubble{ max-width: 70%; }
            .toolbar{ grid-template-columns: repeat(4, 1fr); }
        }
    </style>
</head>

<body>
    <header class="nav-header">
        <h1 id="header-title">DevSpeak</h1>
        <div class="nav-header-icons">
            <div style="font-size:1.1rem;">‚ù§Ô∏è 5</div>
            <div style="font-size:1.1rem;">üî• 10</div>
             <button class="hint-btn" style="color:white; font-size:1.8rem;" onclick="toggleSettingsMenu()">‚ò∞</button>
        </div>
    </header>
    
    <div id="settings-menu" class="settings-menu" onclick="event.target.id === 'settings-menu' && toggleSettingsMenu()">
        <div class="settings-menu-content">
            <h3>Configura√ß√µes</h3>
            <p style="font-size:0.9rem; color:#6b7280; margin-bottom:1.5rem;">
                Aten√ß√£o: Resetar o progresso apagar√° todos os dados salvos localmente no seu navegador.
            </p>
            <button class="btn danger" onclick="resetProgress()">
                ‚ùå Resetar Progresso (Limpar LocalStorage)
            </button>
            <button class="btn secondary" style="margin-top:1rem;" onclick="toggleSettingsMenu()">
                Voltar
            </button>
        </div>
    </div>

    <div id="app" style="width:100%;max-width:800px; padding: 0 clamp(12px, 3.5vw, 32px);"></div>

    <script>
        // 1) DADOS ‚Äî Estrutura Dia, Cen√°rios e Li√ß√µes (ESTRUTURA BASE INICIAL)
        const lessonTypes = [
            { id: 'words', title: 'Vocabul√°rio', icon: 'üìñ' },
            { id: 'phrases', title: 'Frases', icon: 'üí¨' },
            { id: 'conversation', title: 'Simula√ß√£o', icon: 'üó£Ô∏è' }
        ];

        const dailyLessons = {
            A: [ 
                { id: 1, type: 'words', title: 'Vocabul√°rio A', completed: false, words: [{word:'Start with you', translation: 'Vamos come√ßar com voc√™'}, {word:'Awesome!', translation: 'Incr√≠vel!'}, {word:'Noted', translation: 'Anotado'}] },
                { id: 2, type: 'phrases', title: 'Frases A', completed: false, words: [{word:'Let‚Äôs start with you.', translation: 'Vamos come√ßar com voc√™.'}, {word:'Any blockers today?', translation: 'Algum impedimento hoje?'}, {word:'Let‚Äôs sync after the meeting.', translation: 'Vamos nos alinhar ap√≥s a reuni√£o.'}] },
            ],
            B: [ 
                { id: 1, type: 'words', title: 'Vocabul√°rio B', completed: false, words: [{word:'Finalized', translation: 'Finalizei'}, {word:'Blocker', translation: 'Impedimento'}, {word:'OAuth integration', translation: 'Integra√ß√£o OAuth'}] },
                { id: 2, type: 'phrases', title: 'Frases B', completed: false, words: [{word:'I finalized the user authentication module.', translation: 'Eu finalizei o m√≥dulo de autentica√ß√£o de usu√°rio.'}, {word:'I‚Äôm facing an issue with OAuth integration.', translation: 'Estou enfrentando um problema com a integra√ß√£o OAuth.'}] },
            ],
            C: [
                { id: 3, type: 'conversation', title: 'Simula√ß√£o da Daily', completed: false }
            ]
        };
        const planningLessons = {
            A: [ 
                { id: 1, type: 'words', title: 'Vocabul√°rio A', completed: false, words: [{word:'Top priority', translation: 'Prioridade m√°xima'}, {word:'Implement', translation: 'Implementar'}, {word:'Allocate', translation: 'Alocar'}] },
                { id: 2, type: 'phrases', title: 'Frases A', completed: false, words: [{word:'This feature has top priority.', translation: 'Essa funcionalidade tem prioridade m√°xima.'}, {word:'Let‚Äôs allocate some buffer time.', translation: 'Vamos alocar um tempo de reserva.'}] },
            ],
            B: [ 
                { id: 1, type: 'words', title: 'Vocabul√°rio B', completed: false, words: [{word:'Got it', translation: 'Entendi'}, {word:'Database schema', translation: 'Estrutura do banco'}, {word:'Better to be safe', translation: 'Melhor prevenir'}] },
                { id: 2, type: 'phrases', title: 'Frases B', completed: false, words: [{word:'It needs changes in the database schema.', translation: 'Precisa de mudan√ßas na estrutura do banco.'}, {word:'Around two days including testing.', translation: 'Cerca de dois dias, incluindo testes.'}] },
            ],
            C: [
                { id: 3, type: 'conversation', title: 'Simula√ß√£o de Planning', completed: false }
            ]
        };
        
        // Estrutura do Curso (Dias e Cen√°rios) - Inicial (USADO PARA RESET)
        const initialCourseStructure = [
            { 
                id: 1, 
                title: 'Dia 1: Introdu√ß√£o ao Time',
                scenarios: [
                    { 
                        id: 1, name: 'Daily Standup', icon: '‚è∞', completed: false, lessons: dailyLessons,
                        conversations: {
                            A: [
                                { id: "1", pergunta: "Good morning, team! Let‚Äôs start with you, Guilherme.", audio: "audio/scenario-dev-day-1-daily-standup/1.mp3" },
                                { id: "2", pergunta: "Awesome! Any blockers today?", audio: "audio/scenario-dev-day-1-daily-standup/3.mp3" },
                                { id: "3", pergunta: "Noted. Let‚Äôs sync after the meeting.", audio: "audio/scenario-dev-day-1-daily-standup/5.mp3" }
                            ],
                            B: [
                                { id: "1", resposta: "Yesterday I finalized the user authentication module.", audio: "audio/scenario-dev-day-1-daily-standup/2.mp3" },
                                { id: "2", resposta: "Yes, I‚Äôm facing an issue with OAuth integration.", audio: "audio/scenario-dev-day-1-daily-standup/4.mp3" },
                                { id: "3", resposta: "Perfect, thanks!", audio: "audio/scenario-dev-day-1-daily-standup/6.mp3" }
                            ]
                        },
                    },
                    { 
                        id: 2, name: 'Sprint Planning', icon: 'üìÖ', completed: false, lessons: planningLessons,
                        conversations: {
                            A: [
                                { id: "1", pergunta: "This feature has top priority for the next sprint.", audio: "audio/scenario-dev-day-3-sprint-planning/1.mp3" },
                                { id: "2", pergunta: "Will that take much time to implement?", audio: "audio/scenario-dev-day-3-sprint-planning/3.mp3" },
                                { id: "3", pergunta: "Let‚Äôs allocate some buffer time.", audio: "audio/scenario-dev-day-3-sprint-planning/5.mp3" }
                            ],
                            B: [
                                { id: "1", resposta: "Got it. It needs changes in the database schema.", audio: "audio/scenario-dev-day-3-sprint-planning/2.mp3" },
                                { id: "2", resposta: "Around two days including testing.", audio: "audio/scenario-dev-day-3-sprint-planning/4.mp3" },
                                { id: "3", resposta: "Agreed, better to be safe.", audio: "audio/scenario-dev-day-3-sprint-planning/6.mp3" }
                            ]
                        }
                    },
                    { id: 3, name: 'Discutindo Tecnologia', icon: 'üíª', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 4, name: 'Ajudando um Dev', icon: 'ü§ù', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 5, name: 'Sendo Ajuda', icon: 'üôã‚Äç‚ôÇÔ∏è', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 6, name: 'Resolvendo Problema', icon: 'üêõ', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 7, name: 'Entregando Projeto', icon: '‚úÖ', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 8, name: 'Regra de Neg√≥cio', icon: 'üìÑ', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 9, name: 'Conversa Aleat√≥ria', icon: '‚òï', completed: false, lessons: planningLessons, conversations: planningLessons },
                    { id: 10, name: 'Final do Dia', icon: 'üò¥', completed: false, lessons: planningLessons, conversations: planningLessons },
                ]
            },
            { 
                id: 2, 
                title: 'Dia 2: Discuss√µes Avan√ßadas',
                scenarios: [
                    { 
                        id: 1, name: 'Review de C√≥digo', icon: 'üîç', completed: false, lessons: dailyLessons, conversations: dailyLessons 
                    },
                    { 
                        id: 2, name: 'Reuni√£o com Cliente', icon: 'üíº', completed: false, lessons: dailyLessons, conversations: dailyLessons 
                    },
                ]
            }
        ];
        
        let courseStructure = JSON.parse(JSON.stringify(initialCourseStructure)); // Cria uma c√≥pia mut√°vel

        // 2) ESTADO E UTILIDADES (ATUALIZADO COM LOCALSTORAGE E RESET)
        const LOCAL_STORAGE_KEY = 'devspeak_course_progress';

        let stage='map', currentDayIndex=0, currentScenarioIndex=0, currentRole=null, currentLessonIndex=0;
        let flashcardQueue = []; 
        let currentCardIndexInQueue = 0; 
        let isFlashcardFlipped = false;
        let lastInputFailed = false; 
        let lastInputText = ''; 
        
        let role=null, step=0, history=[];

        const app = document.getElementById('app');
        const player = new Audio();
        
        // NOVO: Fun√ß√£o para abrir/fechar o menu de configura√ß√µes
        window.toggleSettingsMenu = () => {
            const menu = document.getElementById('settings-menu');
            menu.classList.toggle('visible');
        };

        // NOVO: Fun√ß√£o para resetar o progresso
        window.resetProgress = () => {
            if (confirm("Tem certeza que deseja resetar todo o seu progresso? Esta a√ß√£o √© irrevers√≠vel.")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                // Reinicia a estrutura do curso para o estado inicial
                courseStructure = JSON.parse(JSON.stringify(initialCourseStructure));
                // Redefine o estado da aplica√ß√£o
                setStage('map', 0, 0, null);
                // Fecha o menu
                toggleSettingsMenu();
                alert("Progresso resetado com sucesso!");
                console.log("LocalStorage limpo e aplica√ß√£o resetada.");
            }
        };

        // [UTILIDADE] Atualiza a estrutura base com o progresso salvo
        const updateCourseStructureFromSavedData = (savedData) => {
            savedData.forEach((savedDay, dIdx) => {
                if (courseStructure[dIdx] && courseStructure[dIdx].id === savedDay.id) {
                    savedDay.scenarios.forEach((savedScenario, sIdx) => {
                        if (courseStructure[dIdx].scenarios[sIdx] && courseStructure[dIdx].scenarios[sIdx].id === savedScenario.id) {
                            courseStructure[dIdx].scenarios[sIdx].completed = savedScenario.completed;
                            ['A', 'B', 'C'].forEach(roleKey => {
                                const lessons = courseStructure[dIdx].scenarios[sIdx].lessons[roleKey];
                                const savedLessons = savedScenario.lessons[roleKey];

                                if (lessons && savedLessons) {
                                    lessons.forEach((lesson, lIdx) => {
                                        if (savedLessons[lIdx] && lesson.id === savedLessons[lIdx].id) {
                                            lesson.completed = savedLessons[lIdx].completed;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            });
        };
        
        // [FUN√á√ÉO] Carrega o progresso do localStorage
        const loadProgress = () => {
            const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    updateCourseStructureFromSavedData(savedData);
                    console.log("Progresso carregado com sucesso.");
                } catch (e) {
                    console.error("Erro ao carregar ou parsear o progresso do localStorage:", e);
                    // Em caso de erro, limpa o progresso inv√°lido
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                }
            }
        };

        // [FUN√á√ÉO] Salva o progresso no localStorage
        const saveProgress = () => {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(courseStructure));
        };
        
        // FIX: Fun√ß√£o para limpar a string para compara√ß√£o
        const cleanStringForComparison = (str) => {
            if (!str) return '';
            let cleaned = str.toLowerCase();
            cleaned = cleaned.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()'"‚Äô‚Äú‚Äù]/g, "");
            cleaned = cleaned.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            return cleaned;
        };


        const scrollToBottom = () => {
            const b = document.getElementById('chat-scroll');
            if (b) b.scrollTop = b.scrollHeight;
        };
        const playAudio = src => { if(!src) return; try{ player.pause(); player.currentTime=0; player.src=src; player.play(); }catch{} };
        const pushMessage = msg => { history.push(msg); if(msg.audio) playAudio(msg.audio); };
        const revealAll = () => document.querySelectorAll('.hidden-text').forEach(el=>el.classList.add('revealed'));
        const hideAll = () => document.querySelectorAll('.hidden-text').forEach(el=>el.classList.remove('revealed'));
        
        const getScenario = () => courseStructure[currentDayIndex]?.scenarios[currentScenarioIndex];

        const getLesson = () => {
            const scenario = getScenario();
            if (!scenario) return null;
            const lessons = scenario.lessons;
            
            if (currentRole === 'A') return lessons.A[currentLessonIndex];
            if (currentRole === 'B') return lessons.B[currentLessonIndex];
            return lessons.C[0]; // Li√ß√£o de Conversa√ß√£o
        };
        
        const getConversation = () => getScenario()?.conversations;
        
        // Fun√ß√£o para tocar o √°udio do flashcard 
        window.playCardAudio = (text, dIdx, sIdx) => {
            const scenario = courseStructure[dIdx]?.scenarios[sIdx];
            if (!scenario) return;

            const sampleAudioPath = scenario.conversations?.A?.[0]?.audio;
            if (!sampleAudioPath) {
                console.error("N√£o foi poss√≠vel encontrar um caminho de √°udio de exemplo para o cen√°rio.");
                return;
            }
            const baseAudioPath = sampleAudioPath.substring(0, sampleAudioPath.lastIndexOf('/')); 
            
            const filename = text
                .toLowerCase()
                .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()'"‚Äô‚Äú‚Äù]/g, '') 
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .trim()
                .replace(/\s+/g, '-'); 
            
            const audioPath = `${baseAudioPath}/flashcard/${filename}.mp3`;
            
            console.log(`Tentando tocar audio em: ${audioPath}`);
            playAudio(audioPath); 
        };


        // 3) RENDERIZA√á√ÉO PRINCIPAL
        const render = () => {
            const currentTitle = courseStructure[currentDayIndex] ? courseStructure[currentDayIndex].title : 'DevSpeak';
            document.getElementById('header-title').textContent = stage === 'map' ? 'DevSpeak' : currentTitle;

            if (stage === 'map') return renderMap();
            if (stage === 'day-scenarios') return renderDayScenarios(); 
            if (stage === 'role-choice-lessons') return renderRoleChoiceLessons(); 
            if (stage === 'flashcard-selector') return renderFlashcardSelector();
            if (stage === 'flashcard') return renderFlashcard();
            if (stage === 'role') return renderRoles();
            return renderChat();
        };

        // 4) TELA MAPA (Mostra os Dias)
        function renderMap(){
            app.innerHTML = `<div id="map-container"><div class="day-path"></div></div>`;
            const path = document.querySelector('.day-path');

            path.innerHTML = courseStructure.map((day, dIdx) => {
                 const dayIcon = 'üìö'; 

                 return `
                    <div class="day-node" onclick="setStage('day-scenarios', ${dIdx})">
                        <div class="main-bubble">${dayIcon}</div>
                        <p style="font-weight:600">${day.title}</p>
                    </div>
                `;
            }).join(`<div></div>`);
        }

        // 5) TELA DE CEN√ÅRIOS DO DIA (Mostra Daily, Planning, etc.)
        function renderDayScenarios() {
            const day = courseStructure[currentDayIndex];
            
            app.innerHTML = `
                <div class="card" style="margin-top:20px;">
                    <h2 style="text-align:center; margin-bottom: 1.5rem;">${day.title}</h2>
                    <div id="scenarios-list" class="day-path" style="padding:0; margin:0; width:100%; position:relative;">
                        ${day.scenarios.map((scenario, sIdx) => {
                            // Verifica se todas as sub-li√ß√µes (A, B, C) est√£o completas para marcar o Cen√°rio
                            const allLessonsCompleted = scenario.lessons.A.every(l => l.completed) && scenario.lessons.B.every(l => l.completed) && scenario.lessons.C[0].completed;
                            scenario.completed = allLessonsCompleted; // Atualiza o status do cen√°rio
                            
                            const statusClass = allLessonsCompleted ? 'completed' : 'active';
                            
                            return `
                                <div class="day-node" onclick="setStage('role-choice-lessons', ${currentDayIndex}, ${sIdx})">
                                    <div class="scenario-bubble ${statusClass}">${scenario.icon}</div>
                                    <p style="font-weight:600; margin-bottom: 0;">${scenario.name}</p>
                                    <p style="margin: 0; color:#6b7280; font-size:.9rem">${allLessonsCompleted ? 'COMPLETO' : 'PENDENTE'}</p>
                                </div>
                                <div></div>
                            `;
                        }).join('')}
                    </div>
                    <button class="btn ghost" onclick="setStage('map')">Voltar aos Dias</button>
                </div>
            `;
            saveProgress(); // Salva ap√≥s recalcular o status do cen√°rio
        }


        // 6) TELA DE LI√á√ïES DETALHADAS POR PAPEL
        function renderRoleChoiceLessons() {
            const day = courseStructure[currentDayIndex];
            const scenario = day.scenarios[currentScenarioIndex];
            const lessons = scenario.lessons;

            const conversationLesson = lessons.C[0];
            const conversationCompleted = conversationLesson.completed;

            const conversationIcon = lessonTypes.find(t => t.id === conversationLesson.type).icon;

            const allRoleALessonsCompleted = lessons.A.every(l => l.completed);
            const allRoleBLessonsCompleted = lessons.B.every(l => l.completed);
            
            const conversationIsActive = allRoleALessonsCompleted && allRoleBLessonsCompleted;

            app.innerHTML = `
                <div class="card" style="margin-top:20px;">
                    <h2 style="text-align:center;">${scenario.name}</h2>
                    <h3 style="text-align:center; margin-top: -1rem; color: #6b7280;">Escolha seu Papel e Treinamento</h3>
                    <div id="lessons-list" class="day-path" style="padding:0; margin:0; width:100%; position:relative;">
                        
                        <div class="day-node" onclick="setStage('flashcard-selector', ${currentDayIndex}, ${currentScenarioIndex}, 'A')" style="cursor:pointer">
                            <div class="sub-bubble role-A ${allRoleALessonsCompleted ? 'completed' : 'active'}" 
                                style="width: 80px; height: 80px; font-size: 2rem;">üë§ A</div>
                            <p style="font-weight:600">Pessoa A (Introdu√ß√£o/Perguntas)</p>
                            <p style="margin: 0; color:#6b7280; font-size:.9rem">${allRoleALessonsCompleted ? 'COMPLETO' : 'PENDENTE'}</p>
                        </div>
                        <div></div>

                        <div class="day-node" onclick="setStage('flashcard-selector', ${currentDayIndex}, ${currentScenarioIndex}, 'B')" style="cursor:pointer">
                            <div class="sub-bubble role-B ${allRoleBLessonsCompleted ? 'completed' : 'active'}" 
                                style="width: 80px; height: 80px; font-size: 2rem;">üë§ B</div>
                            <p style="font-weight:600">Pessoa B (Respostas/Status)</p>
                            <p style="margin: 0; color:#6b7280; font-size:.9rem">${allRoleBLessonsCompleted ? 'COMPLETO' : 'PENDENTE'}</p>
                        </div>
                        <div></div>

                        <div class="day-node" onclick="${conversationIsActive || conversationCompleted ? `startLessonConversation(${currentDayIndex}, ${currentScenarioIndex})` : `alert('Complete as li√ß√µes da Pessoa A e B primeiro!')`}">
                            <div class="sub-bubble ${conversationCompleted ? 'completed' : (conversationIsActive ? 'active' : '')}" 
                                style="width: 80px; height: 80px; font-size: 2rem;">${conversationIcon}</div>
                            <p style="font-weight:600">Simula√ß√£o Completa</p>
                            <p style="margin: 0; color:#6b7280; font-size:.9rem">${conversationLesson.completed ? 'COMPLETO' : 'PRONTO PARA INICIAR'}</p>
                        </div>
                        <div></div>
                    </div>
                    <button class="btn ghost" onclick="setStage('day-scenarios')">Voltar aos Cen√°rios</button>
                </div>
            `;
        }

        // 7) TELA SELE√á√ÉO DE LI√á√ÉO FLASHCARD (Vocabul√°rio ou Frases)
        function renderFlashcardSelector() {
            const day = courseStructure[currentDayIndex];
            const scenario = day.scenarios[currentScenarioIndex];
            const roleLessons = scenario.lessons[currentRole];
            const roleName = currentRole === 'A' ? 'Pessoa A' : 'Pessoa B';
            const roleClass = currentRole === 'A' ? 'role-A' : 'role-B';

            app.innerHTML = `
                <div class="card" style="margin-top:20px;">
                    <h2 style="text-align:center;">${scenario.name}</h2>
                    <h3 style="text-align:center; margin-top: -1rem; color: ${currentRole === 'A' ? 'var(--duo-blue-dark)' : 'var(--duo-green-dark)'}">${roleName} - Sele√ß√£o de Li√ß√£o</h3>
                    <div id="lessons-list" class="day-path" style="padding:0; margin:0; width:100%; position:relative;">
                        ${roleLessons.map((lesson, lIdx) => {
                            const icon = lessonTypes.find(t => t.id === lesson.type).icon;
                            
                            const nextLessonIndex = roleLessons.findIndex(l => !l.completed);
                            const isActive = lIdx === nextLessonIndex;
                            const statusClass = lesson.completed ? 'completed' : (isActive ? 'active' : '');
                            const bubbleClass = statusClass + (lesson.completed ? '' : ` ${roleClass}`);
                            
                            return `
                                <div class="day-node" onclick="${isActive || lesson.completed ? `startFlashcardLesson(${currentDayIndex}, ${currentScenarioIndex}, '${currentRole}', ${lIdx})` : `alert('Complete a li√ß√£o anterior primeiro!')`}">
                                    <div class="sub-bubble ${bubbleClass}" style="width: 60px; height: 60px; border-width: 4px;">${icon}</div>
                                    <p style="font-weight:500">${lesson.title}</p>
                                </div>
                                <div></div>
                            `;
                        }).join('')}
                    </div>
                    <button class="btn ghost" onclick="setStage('role-choice-lessons')">Voltar</button>
                </div>
            `;
        }

        // 8) TELA FLASH CARD (COM √ÅUDIO E FLIP INVERTIDO)
        function renderFlashcard(){
            const lesson = getLesson();
            
            if (flashcardQueue.length === 0) {
                // Se a fila estiver vazia, marca a li√ß√£o como completa e volta
                lesson.completed = true;
                saveProgress(); // SALVA O PROGRESSO
                setStage('flashcard-selector'); 
                return;
            }

            // Pega o √≠ndice real do card na lista 'words' atrav√©s do √≠ndice na fila
            const realCardIndex = flashcardQueue[currentCardIndexInQueue]; 
            const card = lesson.words[realCardIndex];
            const remaining = flashcardQueue.length;
            const max = lesson.words.length; // Tamanho total da li√ß√£o (para fins de exibi√ß√£o)
            const typeTitle = lessonTypes.find(t => t.id === lesson.type).title;

            app.innerHTML = `
                <div class="card" style="margin-top:20px;">
                    <h2 style="text-align:center;">${getScenario().name}</h2>
                    <p style="text-align:center; color:#6b7280">${typeTitle} (${currentRole})</p>
                    <div class="flashcard-container">
                        <div class="flashcard-progress">Restantes: ${remaining} de ${max}</div>
                        <div class="flashcard ${isFlashcardFlipped ? 'flipped' : ''}" onclick="flipCard()">
                            <div class="card-inner">
                                <div class="card-front">
                                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                                        <div style="font-weight: 600; font-size:1.8rem; margin-bottom: 10px;">
                                            ${card.word}
                                        </div>
                                        <button class="audio-btn" title="Ouvir Pron√∫ncia" onclick="event.stopPropagation(); playCardAudio('${card.word}', ${currentDayIndex}, ${currentScenarioIndex})">üîä</button>
                                    </div>
                                </div>
                                
                                <div class="card-back">
                                    <div style="font-weight: 500; font-size:1.5rem; color: #fff;">
                                        ${card.translation}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${isFlashcardFlipped ? `
                            <div class="flashcard-nav" style="flex-direction: column; width: 100%; max-width: 400px; gap: 15px;">
                                <button class="btn primary" style="background:var(--duo-green-dark);" onclick="markAsKnown()">‚úÖ SEI (Remover da fila)</button>
                                <button class="btn secondary" style="color:var(--duo-blue-dark);" onclick="markAsUnknown()">üîÑ N√ÉO SEI (Repetir depois)</button>
                            </div>
                        ` : `
                            <div class="flashcard-nav" style="width: 100%; max-width: 400px;">
                                <button class="btn primary" onclick="flipCard()">REVELAR RESPOSTA</button>
                            </div>
                        `}
                        
                    </div>
                    <button class="btn ghost" onclick="setStage('flashcard-selector')">Voltar √†s Li√ß√µes</button>
                </div>
            `;
        }
        
        // 9) TELA ESCOLHA DE PAPEL (Para a Conversa)
        function renderRoles(){
             app.innerHTML = `
                <div class="card" style="margin-top:20px;">
                    <h2 style="text-align:center;margin-bottom:1rem">${getScenario().name} - Escolha seu Papel</h2>
                    <div class="flex gap-md" style="flex-wrap:wrap">
                        <button class="btn primary" style="flex:1 1 200px; background:var(--duo-blue-dark);" onclick="chooseRole('A')">Pessoa A (Ex: Scrum Master)</button>
                        <button class="btn primary" style="flex:1 1 200px; background:var(--duo-green-dark);" onclick="chooseRole('B')">Pessoa B (Ex: Desenvolvedor)</button>
                    </div>
                    <button class="btn ghost" onclick="setStage('role-choice-lessons')">Voltar</button>
                </div>`;
        }

        // 10) TELA DE CHAT
        function renderChat(){
            const conv = getConversation();
            const finished = (role==='A' && step>=conv.A.length) || (role==='B' && step>=conv.B.length);
            const hist = history.map(msg=>{
                const a = msg.speaker===role ? 'flex-end' : 'flex-start';
                const b = msg.speaker==='A' ? 'bubble-a' : 'bubble-b';
                const au = msg.audio ? `<audio controls><source src="${msg.audio}" type="audio/mpeg"></audio>` : '';
                const txt = `<span class="hidden-text" title="Clique para revelar" onclick="this.classList.toggle('revealed')">${msg.text}</span>`;
                return `<div style="display:flex;justify-content:${a}"><div class="chat-bubble ${b}"><p style="margin:0">${txt}</p>${au}</div></div>`;
            }).join('');

            // Input field with error class and preserved text
            const inp = finished ? `<div style="text-align:center;color:#6b7280">Fim da conversa üéâ</div>` : `
                <div class="input-group" style="flex-wrap: nowrap; margin-top:.5rem">
                    <input id="chat-input" type="text" placeholder="Digite a resposta correta..." 
                           value="${lastInputText}" 
                           class="${lastInputFailed ? 'error-input' : ''}" />
                    <button id="hint-btn" class="hint-btn" title="Mostrar sugest√£o da pr√≥xima fala" aria-label="Mostrar dica">üëÅ</button>
                    <button id="audio-btn" class="audio-btn" title="Ouvir a pr√≥xima fala" aria-label="Ouvir pr√≥xima fala">üîä</button>
                    <button class="btn primary" style="width:auto; flex: 0 0 auto" onclick="send()">Enviar</button>
                    <div id="hint-bubble" class="hint-bubble"></div>
                </div>`;

            app.innerHTML = `
                <div class="card" style="margin-top:20px;">
                    <h2>${getScenario().name} - Simula√ß√£o de Conversa</h2>
                    <div id="chat-scroll" class="chat-scroll">${hist}</div>
                    ${inp}
                    ${lastInputFailed ? '<p style="color: #ef4444; margin: -10px 0 10px 0; text-align:center; font-weight:600;">‚ùå Resposta incorreta. Corrija e envie novamente!</p>' : ''}
                    <div class="toolbar">
                        <button class="btn secondary" onclick="setStage('role-choice-lessons')">üìö Voltar ao Cen√°rio</button>
                        <button class="btn secondary" onclick="playFullScript()">üéß Tocar roteiro</button>
                        <button class="btn secondary" onclick="revealAll()">üëÅÔ∏è Revelar tudo</button>
                        <button class="btn secondary" onclick="hideAll()">üôà Ocultar tudo</button>
                    </div>
                </div>`;

            const ci = document.getElementById('chat-input'),
                hb = document.getElementById('hint-bubble'),
                hbtn = document.getElementById('hint-btn'),
                abtn = document.getElementById('audio-btn');

            if (ci && hbtn && abtn && hb){
                const hintText = role==='A' ? (conv.A[step]?.pergunta || '') : (conv.B[step]?.resposta || '');
                const hintAudio = role==='A' ? (conv.A[step]?.audio || '') : (conv.B[step]?.audio || '');
                hb.textContent = hintText;

                hbtn.onmouseenter = () => { if (matchMedia('(hover: hover)').matches && hintText) hb.style.display = 'block'; };
                hbtn.onmouseleave = () => { if (matchMedia('(hover: hover)').matches) hb.style.display = 'none'; };
                hbtn.onclick = () => { hb.style.display = hb.style.display==='block' ? 'none' : 'block'; };

                abtn.onclick = () => { if (hintAudio) playAudio(hintAudio); };

                ci.focus();
                ci.onkeydown = e => { 
                    if (e.key === 'Enter'){ 
                        e.preventDefault(); 
                        send(); 
                    }
                };
                
                // Limpa o estado de erro assim que o usu√°rio digita algo
                ci.oninput = () => {
                     lastInputText = ci.value; 
                     if (lastInputFailed) {
                         lastInputFailed = false;
                         render(); 
                     }
                };
            }
            scrollToBottom();
        }

        // 11) A√ß√µes (Navega√ß√£o e L√≥gica)
        
        window.setStage = (s, dIdx = currentDayIndex, sIdx = currentScenarioIndex, r = currentRole) => {
            stage=s;
            currentDayIndex = dIdx;
            currentScenarioIndex = sIdx;
            currentRole = r; 
            
            // Limpa o estado do chat ao sair
            if (s !== 'chat'){ step=0; history=[]; lastInputFailed = false; lastInputText = ''; }
            if (s === 'day-scenarios') currentScenarioIndex = null;
            if (s === 'role-choice-lessons') currentRole = null; 
            
            render();
        };

        window.startFlashcardLesson = (dIdx, sIdx, roleKey, lIdx) => {
            currentDayIndex = dIdx;
            currentScenarioIndex = sIdx;
            currentRole = roleKey;
            currentLessonIndex = lIdx;
            
            const lesson = courseStructure[dIdx].scenarios[sIdx].lessons[roleKey][lIdx];
            flashcardQueue = lesson.words.map((_, index) => index); 
            currentCardIndexInQueue = 0;
            isFlashcardFlipped = false;
            
            setStage('flashcard');
        };

        window.markAsKnown = () => {
            flashcardQueue.splice(currentCardIndexInQueue, 1);
            if (flashcardQueue.length > 0) {
                currentCardIndexInQueue = currentCardIndexInQueue % flashcardQueue.length;
            }
            isFlashcardFlipped = false;
            render();
        };

        window.markAsUnknown = () => {
            const cardId = flashcardQueue.splice(currentCardIndexInQueue, 1)[0];
            flashcardQueue.push(cardId);
            currentCardIndexInQueue = currentCardIndexInQueue % flashcardQueue.length;
            isFlashcardFlipped = false;
            render();
        };

        window.startLessonConversation = (dIdx, sIdx) => {
            currentDayIndex = dIdx;
            currentScenarioIndex = sIdx;
            currentRole = 'C';
            currentLessonIndex = 0;
            
            setStage('role'); 
        };

        window.flipCard = () => {
            isFlashcardFlipped = !isFlashcardFlipped;
            render();
        };

        window.chooseRole = r => {
            role=r; setStage('chat');
            const conv = getConversation();
            if (r==='B'){
                const first = conv.A[0];
                pushMessage({ speaker:'A', text:first.pergunta, audio:first.audio });
                step=0;
            } else {
                step=0;
            }
            render();
        };
        
        // FUN√á√ÉO SEND
        window.send = () => {
            const i = document.getElementById('chat-input');
            if (!i || !i.value.trim()) return;

            const t = i.value.trim();
            const co = getConversation();
            const ul = role==='A' ? co.A[step] : co.B[step];
            
            const expectedText = (role==='A' ? ul?.pergunta : ul?.resposta) || '';
            const cleanedInput = cleanStringForComparison(t);
            const cleanedExpected = cleanStringForComparison(expectedText);

            const isCorrect = cleanedInput === cleanedExpected;

            if (isCorrect) {
                lastInputFailed = false; 
                lastInputText = ''; 
                
                pushMessage({ speaker: role, text: t, audio: ul?.audio || null });

                const nextSpeaker = role==='A' ? 'B' : 'A';
                const rl = role==='A' ? co.B[step] : co.A[step+1];
                if (rl) pushMessage({ speaker: nextSpeaker, text: rl.pergunta || rl.resposta, audio: rl.audio });

                step++;
                
                const finished = (role==='A' && step>=co.A.length) || (role==='B' && step>=co.B.length);
                if (finished) {
                    getScenario().lessons.C[0].completed = true; 
                    saveProgress(); // SALVA O PROGRESSO
                } 
                render(); 
            } else {
                lastInputFailed = true;
                lastInputText = t; 
                render(); 
            }
        };

        const playFullScript = async () => {
            const conv = getConversation();
            if (!conv) return;
            const maxLen = Math.max(conv.A.length, conv.B.length);
            for (let i=0;i<maxLen;i++){
                if (conv.A[i]?.audio) await playSequential(conv.A[i].audio);
                if (conv.B[i]?.audio) await playSequential(conv.B[i].audio);
            }
        };
        const playSequential = src => new Promise(res=>{
            player.onended = () => res();
            player.onerror = () => res();
            try{ player.src = src; player.play().catch(()=>res()); }catch{ res(); }
        });


        // Init: 1. Carrega o progresso 2. Renderiza a tela
        loadProgress(); 
        render();
    </script>
</body>
</html>